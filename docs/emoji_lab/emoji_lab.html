<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>HITS with EMOJIS â€“ Emoji Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:#0b1020;
      --card:#151a2c;
      --accent:#ffbf3c;
      --accent-soft:rgba(255,191,60,.15);
      --accent-strong:#ff9f1c;
      --text:#f5f7ff;
      --muted:#a0a4c0;
      --danger:#ff4d6a;
      --success:#45d483;
      --radius:18px;
      --shadow:0 20px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#283157 0,#050816 55%,#020308 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:100%;
      max-width:960px;
      background:linear-gradient(145deg,rgba(255,255,255,.02),rgba(11,16,32,.95));
      border-radius:28px;
      padding:24px 24px 20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-80px -120px auto auto;
      background:radial-gradient(circle at top right,rgba(255,191,60,.22),transparent 65%);
      opacity:.9;
      pointer-events:none;
      z-index:-1;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-pill{
      width:40px;
      height:40px;
      border-radius:999px;
      background:var(--accent-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
    }
    h1{
      font-size:20px;
      font-weight:600;
      letter-spacing:0.02em;
      display:flex;
      align-items:center;
      gap:6px;
    }
    h1 span.small{
      font-size:13px;
      font-weight:500;
      color:var(--muted);
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:flex-end;
      font-size:13px;
      color:var(--muted);
    }
    select,input{
      background:#0f1322;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:6px 12px;
      font-family:inherit;
      font-size:13px;
      outline:none;
    }
    select:focus,input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,191,60,.4);
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      padding:4px 10px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(7,10,24,.9);
    }
    .pill strong{font-weight:600}

    /* Vista: pendents / validades / eliminades */
    .pill-views{
      padding:3px;
      display:flex;
      gap:4px;
      background:rgba(7,10,24,.9);
    }
    .pill-views .btn-view{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s background,.15s color;
    }
    .pill-views .btn-view.active{
      background:var(--accent-soft);
      color:var(--accent-strong);
    }

    main{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.1fr);
      gap:20px;
    }
    @media (max-width:780px){
      main{grid-template-columns:1fr;}
    }
    .song-card{
      background:rgba(9,12,28,.9);
      border-radius:var(--radius);
      padding:16px 16px 14px;
      border:1px solid rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .song-card::after{
      content:"";
      position:absolute;
      inset:auto -40px -80px auto;
      background:radial-gradient(circle at bottom right,rgba(255,159,28,.38),transparent 64%);
      opacity:.7;
      pointer-events:none;
    }
    .song-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(5,8,24,.9);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      margin-bottom:6px;
      position:relative;
      z-index:1;
    }
    .song-badge span.icon{font-size:13px}
    .song-main-title{
      font-size:18px;
      font-weight:600;
      margin-bottom:4px;
      position:relative;
      z-index:1;
    }
    .song-artist{
      font-size:14px;
      color:var(--muted);
      margin-bottom:10px;
      position:relative;
      z-index:1;
    }
    .meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
      margin-bottom:8px;
      position:relative;
      z-index:1;
    }
    .meta-pill{
      padding:3px 8px;
      border-radius:999px;
      background:rgba(10,14,32,.9);
      border:1px solid rgba(255,255,255,.08);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .meta-label{
      color:var(--muted);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .meta-value{
      font-size:11px;
    }
    .tags-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:4px;
      position:relative;
      z-index:1;
    }
    .tag{
      padding:3px 9px;
      border-radius:999px;
      background:rgba(3,5,14,.9);
      border:1px solid rgba(255,255,255,.10);
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .tag span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
    }
    .emoji-card{
      background:rgba(10,14,30,.95);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      border:1px solid rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .emoji-label{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .emoji-label span.left{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .emoji-suggest{
      font-size:26px;
      margin-bottom:4px;
      min-height:34px;
    }
    .emoji-input{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      padding:8px 10px;
      background:#070a17;
      color:var(--text);
      font-size:18px;
      font-family:inherit;
      outline:none;
    }
    .emoji-input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,191,60,.4);
    }
    .ai-hint{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .ai-hint input{
      width:100%;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#050814;
    }
    .buttons-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    button{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-family:inherit;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.15s transform,.15s box-shadow,.15s background;
      white-space:nowrap;
    }
    button:active{
      transform:translateY(1px);
      box-shadow:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#1b1205;
      box-shadow:0 8px 25px rgba(255,191,60,.35);
      font-weight:600;
    }
    .btn-primary.outline{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(255,191,60,.7);
      box-shadow:none;
    }
    .btn-ghost{
      background:rgba(8,12,26,.9);
      color:var(--muted);
      border:1px solid rgba(255,255,255,.15);
    }
    .btn-danger{
      background:rgba(255,77,106,.12);
      color:var(--danger);
      border:1px solid rgba(255,77,106,.6);
    }
    .footer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
      font-size:11px;
      color:var(--muted);
      gap:10px;
    }
    .footer-row strong{color:var(--accent);}
    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      margin-right:4px;
      background:var(--success);
    }
    .progress-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#111426;
      overflow:hidden;
    }
    .progress-bar span{
      display:block;
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent-strong),var(--success));
      transition:width .2s ease-out;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo-pill">ğŸ§</div>
        <div>
          <h1>HITS with EMOJIS <span class="small">Â· Emoji Lab</span></h1>
          <div style="font-size:11px;color:var(--muted);">
            Valida els emojis per cada canÃ§Ã³ Â· es guarda al teu navegador
          </div>
        </div>
      </div>
      <div class="controls">
        <div class="pill pill-views">
          <button id="btnViewPending" class="btn-view active">Pendents</button>
          <button id="btnViewValidated" class="btn-view">Validades</button>
          <button id="btnViewDeleted" class="btn-view">Eliminades</button>
        </div>
        <div class="pill">
          <strong>Idioma:</strong>
          <select id="langFilter">
            <option value="all">Tots</option>
            <option value="ca">CatalÃ </option>
            <option value="es">CastellÃ </option>
            <option value="en">AnglÃ¨s</option>
            <option value="pt">PortuguÃ¨s</option>
            <option value="fr">FrancÃ¨s</option>
            <option value="it">ItaliÃ </option>
            <option value="de">Alemany</option>
          </select>
        </div>
        <div class="pill">
          <strong>Popularitat mÃ­n.:</strong>
          <input id="minPop" type="number" min="0" max="100" value="0" style="width:64px;text-align:center;">
        </div>
        <button id="downloadJsonBtn" class="btn-ghost">
          ğŸ“¥ Descarregar JSON
        </button>
      </div>
    </header>

    <main>
      <section class="song-card">
        <div class="song-badge">
          <span class="icon">ğŸµ</span>
          <span id="songIndexLabel">0 / 0</span>
        </div>
        <div class="song-main-title" id="songTitle">Carregant canÃ§onsâ€¦</div>
        <div class="song-artist" id="songArtist"></div>

        <div class="meta-row">
          <div class="meta-pill">
            <span class="meta-label">DÃ¨cada</span>
            <span class="meta-value" id="songDecade">â€”</span>
          </div>
          <div class="meta-pill">
            <span class="meta-label">Any</span>
            <span class="meta-value" id="songYear">â€”</span>
          </div>
          <div class="meta-pill">
            <span class="meta-label">Idioma</span>
            <span class="meta-value" id="songLang">â€”</span>
          </div>
          <div class="meta-pill">
            <span class="meta-label">Popularitat</span>
            <span class="meta-value" id="songPopularity">â€”</span>
          </div>
        </div>

        <div class="tags-row">
          <div class="tag" id="genresTag">
            <span class="dot"></span><span id="songGenres">â€”</span>
          </div>
          <div class="tag" id="moodTag">
            <span class="dot"></span><span id="songMood">â€”</span>
          </div>
          <div class="tag">
            <span>ğŸ‘ï¸</span><span id="songViews">â€”</span>
          </div>
        </div>

        <div style="font-size:11px;color:var(--muted);margin-top:6px;">
          <span id="songSource">Playlist original: â€”</span>
        </div>
      </section>

      <section class="emoji-card">
        <div class="emoji-label">
          <span class="left">
            <span>âœ¨ Proposta dâ€™emojis (basada en el tÃ­tol)</span>
          </span>
          <span id="emojiStatusText">Encara no validat</span>
        </div>

        <div class="emoji-suggest" id="emojiSuggest"></div>

        <input
          id="emojiInput"
          class="emoji-input"
          placeholder="Escriu o edita aquÃ­ els emojis per aquesta canÃ§Ã³â€¦"
        />

        <div class="ai-hint">
          <span>
            ğŸ’¬ Pista per a la IA (opcional) â€” ex: â€œafegeix algun emoji de foc i festaâ€
          </span>
          <input id="aiHint" placeholder="Escriu aquÃ­ quÃ¨ vols que tingui la proposta dâ€™emojisâ€¦" />
        </div>

        <div class="buttons-row">
          <button id="btnAccept" class="btn-primary">
            âœ… Acceptar i segÃ¼ent
          </button>
          <button id="btnSaveOnly" class="btn-primary outline">
            âœï¸ NomÃ©s guardar emojis
          </button>
          <button id="btnSkip" class="btn-ghost">
            â­ï¸ Saltar (no fer res)
          </button>
          <button id="btnDeleteSong" class="btn-danger">
            ğŸ—‘ï¸ Eliminar aquesta canÃ§Ã³
          </button>
        </div>

        <div class="buttons-row">
          <button id="btnAIHint" class="btn-ghost">
            ğŸ§  Aplicar pista IA
          </button>
          <button id="btnAIRefresh" class="btn-ghost">
            ğŸ” Nova proposta (IA)
          </button>
        </div>
      </section>
    </main>

    <div class="footer-row">
      <div style="display:flex;align-items:center;gap:6px;">
        <span class="status-dot"></span>
        <span id="summaryText">Carregantâ€¦</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;min-width:140px;">
        <div class="progress-bar">
          <span id="progressBarFill"></span>
        </div>
        <span id="progressPercent">0%</span>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”— URL del Worker dâ€™IA
    const EMOJI_API_URL = "https://emoji-worker.ramonpertinez.workers.dev";

    const SONGS_URL = "songs_local.json";
    const stateKey = "hitsEmojiState_v1";

    let allSongs = [];
    let filteredSongs = [];
    let currentIndex = 0;
    let currentSongId = null; // per evitar sobrescriure si canvies rÃ pid de canÃ§Ã³
    let state = {
      validated: {}, // id -> emojis
      deleted: {},   // id -> true
      lang: "all",
      minPop: 0,
      viewMode: "pending" // "pending" | "validated" | "deleted"
    };

    function $(id){return document.getElementById(id);}

    function loadState(){
      try{
        const raw = localStorage.getItem(stateKey);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        state = Object.assign(state, parsed || {});
      }catch(e){
        console.warn("No s'ha pogut carregar l'estat", e);
      }
    }

    function saveState(){
      try{
        localStorage.setItem(stateKey, JSON.stringify(state));
      }catch(e){
        console.warn("No s'ha pogut guardar l'estat", e);
      }
    }

    function formatViews(n){
      if(!n && n !== 0) return "â€”";
      if(n >= 1_000_000_000) return (n/1_000_000_000).toFixed(1).replace(/\.0$/,"")+"B";
      if(n >= 1_000_000) return (n/1_000_000).toFixed(1).replace(/\.0$/,"")+"M";
      if(n >= 1_000) return (n/1_000).toFixed(1).replace(/\.0$/,"")+"k";
      return n.toString();
    }

    function langLabel(code){
      const map = {
        ca:"CatalÃ ",
        es:"CastellÃ ",
        en:"AnglÃ¨s",
        pt:"PortuguÃ¨s",
        fr:"FrancÃ¨s",
        it:"ItaliÃ ",
        de:"Alemany"
      };
      return map[code] || code || "â€”";
    }

    // ğŸ”¡ Diccionari gran paraula â†’ llista d'emojis possibles
    const EMOJI_WORD_MAP = {
      // AMOR / RELACIONS
      "amor": ["â¤ï¸","ğŸ’˜","ğŸ’–","ğŸ’“","ğŸ’","ğŸ’"],
      "estima": ["â¤ï¸","ğŸ¤","ğŸ’"],
      "cor": ["â¤ï¸","ğŸ«€","ğŸ’“"],
      "corazon": ["â¤ï¸","ğŸ’˜","ğŸ’—"],
      "heart": ["â¤ï¸","ğŸ’˜","ğŸ’—"],
      "love": ["â¤ï¸","ğŸ’•","ğŸ’˜"],
      "beso": ["ğŸ’‹","ğŸ˜˜","ğŸ’Œ"],
      "kiss": ["ğŸ’‹","ğŸ˜˜","ğŸ˜™"],
      "amigos": ["ğŸ‘¥","ğŸ§‘â€ğŸ¤â€ğŸ§‘","ğŸ¤"],
      "amics": ["ğŸ‘¥","ğŸ§‘â€ğŸ¤â€ğŸ§‘","ğŸ¤"],
      "friend": ["ğŸ‘¤","ğŸ‘¥","ğŸ§‘â€ğŸ¤â€ğŸ§‘"],
      "friends": ["ğŸ‘¥","ğŸ§‘â€ğŸ¤â€ğŸ§‘","ğŸ¤"],
      "solo": ["ğŸ˜”","ğŸ˜¢","ğŸ–¤"],
      "soledad": ["ğŸ˜”","ğŸŒ§ï¸","ğŸ’­"],
      "alone": ["ğŸ˜”","ğŸŒ§ï¸","ğŸŒ™"],

      // EMOCIONS
      "feliz": ["ğŸ˜Š","ğŸ˜„","ğŸ˜"],
      "happy": ["ğŸ˜Š","ğŸ˜„","ğŸ˜ƒ","ğŸŒ"],
      "alegria": ["ğŸ˜„","ğŸ‰","ğŸ¥³"],
      "triste": ["ğŸ˜¢","ğŸ˜­","ğŸ’”"],
      "sad": ["ğŸ˜¢","ğŸ˜­","ğŸ’§"],
      "llorar": ["ğŸ˜­","ğŸ’§","ğŸ˜¢"],
      "plorar": ["ğŸ˜­","ğŸ’§","ğŸ˜¢"],
      "loco": ["ğŸ¤ª","ğŸ˜œ","ğŸŒ€"],
      "crazy": ["ğŸ¤ª","ğŸ¤¯","ğŸ˜µâ€ğŸ’«"],
      "miedo": ["ğŸ˜±","ğŸ‘»","ğŸŒ‘"],

      // NATURA / LLOC
      "sol": ["â˜€ï¸","ğŸŒ","ğŸ˜"],
      "sun": ["â˜€ï¸","ğŸŒ"],
      "luna": ["ğŸŒ™","ğŸŒœ","âœ¨"],
      "lluna": ["ğŸŒ™","ğŸŒœ","âœ¨"],
      "moon": ["ğŸŒ™","ğŸŒ","âœ¨"],
      "estrella": ["â­","ğŸŒŸ","âœ¨"],
      "stars": ["â­","ğŸŒŸ","âœ¨"],
      "estreles": ["â­","ğŸŒŸ"],
      "estels": ["â­","ğŸŒŸ"],
      "cielo": ["ğŸŒ¤ï¸","â˜ï¸","ğŸŒˆ"],
      "sky": ["ğŸŒ¤ï¸","â˜ï¸","ğŸŒˆ"],
      "cel": ["ğŸŒ¤ï¸","â˜ï¸","ğŸŒˆ"],
      "mar": ["ğŸŒŠ","ğŸŒŠ","ğŸš"],
      "sea": ["ğŸŒŠ","ğŸš","ğŸš¤"],
      "ocean": ["ğŸŒŠ","ğŸ¬","ğŸš"],
      "oceano": ["ğŸŒŠ","ğŸ¬","ğŸš"],
      "platja": ["ğŸ–ï¸","ğŸŒŠ","ğŸŒ…"],
      "playa": ["ğŸ–ï¸","ğŸŒŠ","ğŸŒ´"],
      "beach": ["ğŸ–ï¸","ğŸŒŠ","ğŸŒ´"],
      "montana": ["â›°ï¸","ğŸ”ï¸","ğŸŒ„"],
      "montanya": ["â›°ï¸","ğŸ”ï¸","ğŸŒ„"],
      "mountain": ["â›°ï¸","ğŸ”ï¸","ğŸŒ„"],
      "bosque": ["ğŸŒ²","ğŸŒ³","ğŸŒ¿"],
      "bosc": ["ğŸŒ²","ğŸŒ³","ğŸŒ¿"],
      "rain": ["ğŸŒ§ï¸","â˜”","ğŸ’§"],
      "lluvia": ["ğŸŒ§ï¸","â˜”","ğŸ’§"],
      "pluja": ["ğŸŒ§ï¸","â˜”","ğŸ’§"],
      "fuego": ["ğŸ”¥","ğŸ”¥","ğŸ”¥"],
      "fire": ["ğŸ”¥","ğŸ”¥","ğŸ’¥"],
      "foc": ["ğŸ”¥","ğŸ”¥","ğŸ’¥"],

      // FESTA / NIT / CLUB
      "fiesta": ["ğŸ‰","ğŸ¥³","ğŸ¾"],
      "party": ["ğŸ‰","ğŸ¥³","ğŸŠ"],
      "discoteca": ["ğŸ•º","ğŸ’ƒ","ğŸ›ï¸"],
      "club": ["ğŸ•º","ğŸ’ƒ","ğŸ›ï¸"],
      "rave": ["ğŸ•º","ğŸ›ï¸","âš¡"],
      "bailar": ["ğŸ’ƒ","ğŸ•º","ğŸ¶"],
      "dance": ["ğŸ’ƒ","ğŸ•º","ğŸ¶"],
      "ballar": ["ğŸ’ƒ","ğŸ•º","ğŸ¶"],
      "baile": ["ğŸ’ƒ","ğŸ•º","ğŸ¶"],
      "night": ["ğŸŒ™","ğŸŒŒ","ğŸŒƒ"],
      "noche": ["ğŸŒ™","ğŸŒƒ","âœ¨"],
      "nit": ["ğŸŒ™","ğŸŒƒ","âœ¨"],

      // MOVIMENT / VIATGE
      "camino": ["ğŸ›£ï¸","ğŸ‘£","â¡ï¸"],
      "camins": ["ğŸ›£ï¸","ğŸ‘£","â¡ï¸"],
      "road": ["ğŸ›£ï¸","ğŸš—","ğŸ‘£"],
      "ruta": ["ğŸ›£ï¸","ğŸ§­","ğŸš—"],
      "coche": ["ğŸš—","ğŸš™","ğŸï¸"],
      "cotxe": ["ğŸš—","ğŸš™"],
      "car": ["ğŸš—","ğŸš™"],
      "tren": ["ğŸš†","ğŸš"],
      "train": ["ğŸš†","ğŸš"],
      "avion": ["âœˆï¸","ğŸ›«","ğŸ›¬"],
      "aviÃ³": ["âœˆï¸","ğŸ›«","ğŸ›¬"],
      "plane": ["âœˆï¸","ğŸ›«","ğŸ›¬"],
      "fly": ["ğŸ•Šï¸","âœˆï¸","â¬†ï¸"],
      "viaje": ["ğŸ§³","âœˆï¸","ğŸš†"],
      "viatge": ["ğŸ§³","âœˆï¸","ğŸš—"],
      "trip": ["ğŸ§³","âœˆï¸","ğŸŒ"],
      "journey": ["ğŸ§³","ğŸ›£ï¸","ğŸŒ"],
      "ciudad": ["ğŸŒ†","ğŸ™ï¸"],
      "ciutat": ["ğŸŒ†","ğŸ™ï¸"],
      "city": ["ğŸŒ†","ğŸ™ï¸"],

      // TEMPS / RECORDS
      "tiempo": ["â³","âŒ›","â°"],
      "time": ["â³","âŒ›","â°"],
      "temps": ["â³","âŒ›","â°"],
      "reloj": ["â°","âŒš"],
      "clock": ["â°","â±ï¸"],
      "ayer": ["ğŸ“¼","ğŸ•°ï¸"],
      "yesterday": ["ğŸ“¼","ğŸ•°ï¸"],
      "ahir": ["ğŸ“¼","ğŸ•°ï¸"],
      "recuerdos": ["ğŸ’­","ğŸ§ ","ğŸ“¸"],
      "memories": ["ğŸ’­","ğŸ§ ","ğŸ“¸"],
      "records": ["ğŸ’­","ğŸ§ ","ğŸ“¸"],

      // OBJECTES / COSA
      "casa": ["ğŸ ","ğŸ¡"],
      "home": ["ğŸ ","ğŸ¡"],
      "llar": ["ğŸ ","ğŸ¡"],
      "llave": ["ğŸ”‘","ğŸ—ï¸"],
      "llaves": ["ğŸ”‘","ğŸ—ï¸"],
      "key": ["ğŸ”‘","ğŸ—ï¸"],
      "keys": ["ğŸ”‘","ğŸ—ï¸"],
      "corona": ["ğŸ‘‘"],
      "rey": ["ğŸ‘‘"],
      "queen": ["ğŸ‘‘"],
      "rei": ["ğŸ‘‘"],
      "reina": ["ğŸ‘‘"],
      "guerra": ["âš”ï¸","ğŸ”¥"],
      "war": ["âš”ï¸","ğŸ”¥"],
      "sueÃ±o": ["ğŸ’¤","ğŸ’­"],
      "suenos": ["ğŸ’¤","ğŸ’­"],
      "somni": ["ğŸ’¤","ğŸ’­"],
      "somnis": ["ğŸ’¤","ğŸ’­"],

      // COLORS
      "yellow": ["ğŸŸ¡","ğŸŒ•","âœ¨"],
      "groc": ["ğŸŸ¡","ğŸŒ•"],
      "amarillo": ["ğŸŸ¡","ğŸŒ•"],
      "blue": ["ğŸ”µ","ğŸŒŠ","ğŸ’™"],
      "blau": ["ğŸ”µ","ğŸ’™"],
      "azul": ["ğŸ”µ","ğŸ’™"],
      "rojo": ["ğŸ”´","â¤ï¸"],
      "vermell": ["ğŸ”´","â¤ï¸"],
      "red": ["ğŸ”´","â¤ï¸"],
      "negro": ["âš«","ğŸ–¤"],
      "negra": ["âš«","ğŸ–¤"],
      "black": ["âš«","ğŸ–¤"],
      "white": ["âšª"],
      "blanco": ["âšª"],
      "blanc": ["âšª"],

      // NÃšMEROS
      "dos": ["2ï¸âƒ£","âœŒï¸"],
      "tres": ["3ï¸âƒ£"],
      "cuatro": ["4ï¸âƒ£"],
      "quatre": ["4ï¸âƒ£"],
      "cinco": ["5ï¸âƒ£"],
      "cinc": ["5ï¸âƒ£"],
      "siete": ["7ï¸âƒ£"],
      "set": ["7ï¸âƒ£"],
      "diez": ["ğŸ”Ÿ"],
      "deu": ["ğŸ”Ÿ"]
    };

    // Frases o patrons especials (multi-paraula)
    const EMOJI_PATTERNS = [
      { re: /camisa negra/, emojis: ["ğŸ‘”","âš«"] },
      { re: /la gent que estimo/, emojis: ["ğŸ‘¥","â¤ï¸"] },
      { re: /una lluna a l.?aigua/, emojis: ["ğŸŒ™","ğŸ’§"] },
      { re: /al mar/, emojis: ["ğŸŒŠ","â›µ"] },
      { re: /viva la vida/, emojis: ["ğŸ‰","ğŸŒ"] },
      { re: /thunderstruck|thunder/, emojis: ["âš¡","ğŸ¤¯"] },
      { re: /fix you/, emojis: ["ğŸ©¹","ğŸ’¡"] },
      { re: /la playa/, emojis: ["ğŸ–ï¸","ğŸŒŠ"] },
      { re: /let her go/, emojis: ["ğŸ‘‹","ğŸš¶â€â™€ï¸","ğŸ’”"] },
      { re: /bad romance/, emojis: ["ğŸ’”","ğŸ˜µâ€ğŸ’«","ğŸ’ƒ"] }
    ];

    // ğŸ”¥ GENERADOR D'EMOJIS LOCAL (tÃ­tol + mood)
    function suggestEmojis(song){
      const rawTitle = (song.title || "").trim();
      if(!rawTitle) return "ğŸµ";

      const title = rawTitle
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");

      const em = [];

      for(const rule of EMOJI_PATTERNS){
        if(rule.re.test(title)){
          em.push(...rule.emojis);
        }
      }

      const tokens = title.split(/[^a-z0-9Ã±Ã§]+/).filter(Boolean);
      for(const token of tokens){
        const mapping = EMOJI_WORD_MAP[token];
        if(mapping && mapping.length){
          for(let i=0; i<Math.min(mapping.length,2); i++){
            em.push(mapping[i]);
          }
        }
      }

      if(em.length === 0 && Array.isArray(song.mood)){
        const moodText = song.mood.join(" ").toLowerCase();
        if(moodText.includes("party") || moodText.includes("energetic")){
          em.push("ğŸ‰","ğŸ”¥");
        } else if(moodText.includes("romantic")){
          em.push("â¤ï¸","ğŸ’˜");
        } else if(moodText.includes("sad")){
          em.push("ğŸ’”","ğŸ˜¢");
        } else if(moodText.includes("chill") || moodText.includes("focus")){
          em.push("ğŸŒ™","â˜•");
        }
      }

      if(em.length === 0){
        return "ğŸµ";
      }

      const dedup = [];
      for(const e of em){
        if(!dedup.includes(e)){
          dedup.push(e);
          if(dedup.length >= 3) break;
        }
      }
      return dedup.join(" ");
    }

    // ğŸ”— Crida al Worker d'IA (ara amb hint + currentEmojis)
    async function fetchAIEmojisForSong(song, opts = {}) {
      const payload = {
        title: song.title,
        artist: song.artist,
        language: song.language,
        mood: song.mood || [],
        hint: opts.hint || "",
        currentEmojis: opts.currentEmojis || ""
      };

      try {
        const res = await fetch(EMOJI_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          console.warn("Emoji IA error:", await res.text());
          return null;
        }

        const data = await res.json();
        return data.emojis || null;
      } catch (e) {
        console.error("Error cridant Worker IA:", e);
        return null;
      }
    }

    // Actualitza l'estat visual dels botons de vista
    function updateViewButtons(){
      const mode = state.viewMode || "pending";
      $("btnViewPending").classList.toggle("active", mode === "pending");
      $("btnViewValidated").classList.toggle("active", mode === "validated");
      $("btnViewDeleted").classList.toggle("active", mode === "deleted");
    }

    // Filtra canÃ§ons segons idioma, popularitat, vista (pendents/validades/eliminades)
    function applyFilters(options = {}) {
      const resetIndex = options.resetIndex !== undefined ? options.resetIndex : true;
      const lang = state.lang || "all";
      const minPop = Number(state.minPop) || 0;
      const mode = state.viewMode || "pending";

      filteredSongs = allSongs.filter(s => {
        if (mode === "deleted") {
          // NomÃ©s canÃ§ons eliminades
          return !!state.deleted[s.id];
        }

        // Per la resta de modes, amaguem les eliminades
        if (state.deleted[s.id]) return false;

        if (lang !== "all" && s.language !== lang) return false;
        if (typeof s.popularity === "number" && !isNaN(s.popularity)) {
          if (s.popularity < minPop) return false;
        }

        if (mode === "pending" && state.validated[s.id]) return false;
        if (mode === "validated" && !state.validated[s.id]) return false;

        return true;
      });

      filteredSongs.sort((a,b) => (b.popularity||0) - (a.popularity||0));

      if (resetIndex) {
        currentIndex = 0;
      } else {
        if (currentIndex >= filteredSongs.length) {
          currentIndex = Math.max(0, filteredSongs.length - 1);
        }
      }

      render();
    }

    function render(){
      const total = filteredSongs.length;
      const mode = state.viewMode || "pending";

      if(total === 0){
        $("songTitle").textContent = "Cap canÃ§Ã³ amb aquest filtre ğŸ¥²";
        $("songArtist").textContent = "";
        $("songDecade").textContent = "â€”";
        $("songYear").textContent = "â€”";
        $("songLang").textContent = "â€”";
        $("songPopularity").textContent = "â€”";
        $("songGenres").textContent = "â€”";
        $("songMood").textContent = "â€”";
        $("songViews").textContent = "â€”";
        $("songSource").textContent = "Playlist original: â€”";
        $("emojiSuggest").textContent = "";
        $("emojiInput").value = "";
        $("songIndexLabel").textContent = "0 / 0";

        let msg = "Cap canÃ§Ã³ pendent amb aquests filtres.";
        if (mode === "validated") msg = "No hi ha cap canÃ§Ã³ validada amb aquests filtres.";
        if (mode === "deleted") msg = "No hi ha cap canÃ§Ã³ eliminada amb aquests filtres.";

        $("summaryText").textContent = msg + " Canvia de vista, idioma o popularitat mÃ­nima.";
        $("progressBarFill").style.width = "0%";
        $("progressPercent").textContent = "0%";
        $("emojiStatusText").textContent = "â€”";

        updateViewButtons();
        return;
      }

      if(currentIndex < 0) currentIndex = 0;
      if(currentIndex >= total) currentIndex = total - 1;

      const song = filteredSongs[currentIndex];
      currentSongId = song.id;

      const idxLabel = `${currentIndex+1} / ${total}`;
      $("songIndexLabel").textContent = idxLabel;

      $("songTitle").textContent = song.title || "â€”";
      $("songArtist").textContent = song.artist || "â€”";
      $("songDecade").textContent = song.decade || "â€”";
      $("songYear").textContent = song.year || "â€”";
      $("songLang").textContent = langLabel(song.language);
      $("songPopularity").textContent =
        (song.popularity ?? "â€”").toString();
      $("songGenres").textContent =
        (song.genres && song.genres.length)
          ? song.genres.join(", ")
          : "â€”";
      $("songMood").textContent =
        (song.mood && song.mood.length)
          ? song.mood.join(", ")
          : "â€”";
      $("songViews").textContent = formatViews(song.youtube_views_estimate);
      $("songSource").textContent =
        "Playlist original: " + (song.source_playlist || "â€”");

      const existing = state.validated[song.id];

      $("aiHint").value = "";

      if(existing){
        $("emojiSuggest").textContent = existing || "â€”";
        $("emojiInput").value = existing;
        $("emojiStatusText").textContent = "âœ… Ja validada (pots editar-la)";
      } else {
        const localSuggestion = suggestEmojis(song);
        $("emojiSuggest").textContent = localSuggestion || "â€”";
        $("emojiInput").value = localSuggestion;
        $("emojiStatusText").textContent = "âœ¨ Proposta local... esperant IA";

        fetchAIEmojisForSong(song).then(ai => {
          if (!ai) {
            if (currentSongId === song.id && !state.validated[song.id]) {
              $("emojiStatusText").textContent = "âœ¨ Proposta local (IA no disponible)";
            }
            return;
          }

          if (currentSongId === song.id && !state.validated[song.id]) {
            if ($("emojiInput").value === localSuggestion) {
              $("emojiInput").value = ai;
              $("emojiSuggest").textContent = ai;
              $("emojiStatusText").textContent = "ğŸ¤– Proposta amb IA";
            }
          }
        });
      }

      // Text i comportament del botÃ³ eliminar / recuperar
      if (mode === "deleted") {
        $("btnDeleteSong").textContent = "â™»ï¸ Recuperar aquesta canÃ§Ã³";
      } else {
        $("btnDeleteSong").textContent = "ğŸ—‘ï¸ Eliminar aquesta canÃ§Ã³";
      }

      // Barra de progrÃ©s global (sobre totes les actives)
      const totalSongs = allSongs.filter(s => !state.deleted[s.id]).length;
      const validatedCount = Object.keys(state.validated).filter(id => !state.deleted[id]).length;
      const percentRaw = totalSongs ? (validatedCount * 100 / totalSongs) : 0;
      const percentText = percentRaw < 10
        ? percentRaw.toFixed(1)
        : Math.round(percentRaw).toString();

      $("summaryText").textContent =
        `Validades: ${validatedCount} Â· Eliminades: ${Object.keys(state.deleted).length} Â· Total actives: ${totalSongs}`;
      $("progressBarFill").style.width = Math.min(100, percentRaw) + "%";
      $("progressPercent").textContent = percentText + "%";

      updateViewButtons();
    }

    function nextSong(){
      currentIndex++;
      if(currentIndex >= filteredSongs.length){
        currentIndex = filteredSongs.length - 1;
      }
      render();
    }

    function saveEmojisForCurrent(){
      if(!filteredSongs.length) return;
      const song = filteredSongs[currentIndex];
      const val = $("emojiInput").value.trim();
      if(val){
        state.validated[song.id] = val;
      }else{
        delete state.validated[song.id];
      }
      saveState();
      render();
    }

    function deleteCurrentSong(){
      if(!filteredSongs.length) return;
      const song = filteredSongs[currentIndex];
      state.deleted[song.id] = true;
      delete state.validated[song.id];
      saveState();
      applyFilters({ resetIndex: false });
    }

    function restoreCurrentSong(){
      if (!filteredSongs.length) return;
      const song = filteredSongs[currentIndex];
      delete state.deleted[song.id];
      saveState();
      applyFilters({ resetIndex: false });
    }

    function downloadJson(){
      const entries = allSongs.map(s => ({
        id: s.id,
        title: s.title,
        artist: s.artist,
        emojis: state.validated[s.id] || "",
        deleted: !!state.deleted[s.id],
        language: s.language,
        decade: s.decade,
        popularity: s.popularity
      }));
      const blob = new Blob(
        [JSON.stringify(entries,null,2)],
        {type:"application/json"}
      );
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "hits_emojis_mapping.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ğŸ” Re-generar emojis amb pista o sense
    async function regenerateEmojisWithAI({ useHint = false, forceNew = false } = {}) {
      if (!filteredSongs.length) return;
      const song = filteredSongs[currentIndex];
      const base = $("emojiInput").value.trim();
      let hint = "";

      if (useHint) {
        hint = $("aiHint").value.trim();
      }

      if (!hint && forceNew) {
        hint = "Genera una proposta d'emojis diferent i mÃ©s creativa, evitant repetir exactament la combinaciÃ³ anterior.";
      }

      $("emojiStatusText").textContent = "ğŸ¤– Pensant noves combinacionsâ€¦";

      const ai = await fetchAIEmojisForSong(song, {
        hint,
        currentEmojis: base
      });

      if (!ai) {
        $("emojiStatusText").textContent = "âœ¨ No s'ha pogut millorar la proposta (mantinc l'actual)";
        return;
      }

      if (currentSongId === song.id) {
        $("emojiInput").value = ai;
        $("emojiSuggest").textContent = ai;
        $("emojiStatusText").textContent = useHint
          ? "ğŸ¤– Proposta ajustada amb la teva pista"
          : "ğŸ¤– Nova proposta d'emojis (IA)";
      }
    }

    async function init(){
      loadState();

      $("langFilter").value = state.lang || "all";
      $("minPop").value = state.minPop || 0;

      $("langFilter").addEventListener("change", () => {
        state.lang = $("langFilter").value;
        saveState();
        applyFilters({ resetIndex: true });
      });
      $("minPop").addEventListener("change", () => {
        state.minPop = Number($("minPop").value) || 0;
        saveState();
        applyFilters({ resetIndex: true });
      });

      $("btnViewPending").addEventListener("click", () => {
        state.viewMode = "pending";
        saveState();
        applyFilters({ resetIndex: true });
      });
      $("btnViewValidated").addEventListener("click", () => {
        state.viewMode = "validated";
        saveState();
        applyFilters({ resetIndex: true });
      });
      $("btnViewDeleted").addEventListener("click", () => {
        state.viewMode = "deleted";
        saveState();
        applyFilters({ resetIndex: true });
      });

      $("btnAccept").addEventListener("click", () => {
        saveEmojisForCurrent();
        nextSong();
      });
      $("btnSaveOnly").addEventListener("click", () => {
        saveEmojisForCurrent();
      });
      $("btnSkip").addEventListener("click", () => {
        nextSong();
      });
      $("btnDeleteSong").addEventListener("click", () => {
        if (state.viewMode === "deleted") {
          if(confirm("Vols recuperar aquesta canÃ§Ã³ al joc?")){
            restoreCurrentSong();
          }
        } else {
          if(confirm("Segur que vols eliminar aquesta canÃ§Ã³ del joc?")){
            deleteCurrentSong();
          }
        }
      });
      $("downloadJsonBtn").addEventListener("click", downloadJson);

      $("btnAIHint").addEventListener("click", () => {
        regenerateEmojisWithAI({ useHint: true, forceNew: false });
      });
      $("btnAIRefresh").addEventListener("click", () => {
        regenerateEmojisWithAI({ useHint: false, forceNew: true });
      });

      try{
        const res = await fetch(SONGS_URL);
        if(!res.ok){
          $("songTitle").textContent = "No s'ha pogut carregar songs_local.json";
          return;
        }
        allSongs = await res.json();
        allSongs.sort((a,b) => (b.popularity||0) - (a.popularity||0));
        applyFilters({ resetIndex: true });
      }catch(e){
        console.error(e);
        $("songTitle").textContent = "Error carregant songs_local.json";
      }
    }

    init();
  </script>
</body>
</html>
